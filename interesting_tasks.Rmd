```{r setup, include=FALSE}
devtools::load_all("omlTuneBenchRLocal/")
library("DT")
get_runs_local = get_runs

my_apply = function(df, fn) {
  apply(df, 1, function(both) {
    algo_id = both["algo_id"]
    task_id = as.numeric(both["task_id"])
    fn(algo_id = algo_id, task_id = task_id)
  })
}

```
```{r data, include=FALSE}
runs = expand.grid(algo_id = get_available_algos(), task_id = get_available_tasks())
n.runs = my_apply(runs, function(algo_id, task_id) {
  runs = get_runs_local(algo_id, task_id)
  nrow(runs)
})

# Filter algo+task combos which don't have any runs at all
runs = runs[n.runs > 0,]
n.runs = n.runs[n.runs > 0]
```
```{r plots, include=FALSE, fig.width=8, fig.height=6, fig.path="hist_acc/"}
my_apply(runs, function(algo_id, task_id) {
  runs = get_runs_local(algo_id, task_id)
  invisible(hist(runs$accuracy))
})
```
```{r plots2, include=FALSE, fig.width=8, fig.height=6, fig.path="hist_rt/"}
my_apply(runs, function(algo_id, task_id) {
  runs = get_runs_local(algo_id, task_id)
  invisible(hist(runs$runtime / runs$scimark))
})
```
```{r measures, include=FALSE}

# Hardness
maxq = my_apply(runs, function(algo_id, task_id) {
  runs = get_runs_local(algo_id, task_id)
  acc = runs$accuracy
  max(acc) - quantile(acc, 0.95)
})

# Normalized and Unnormalized runtimes
mad.runtime = my_apply(runs, function(algo_id, task_id) {
  runs = get_runs_local(algo_id, task_id)
  runtime = runs$runtime
  mad(runtime)
})
mad.norm.runtime = my_apply(runs, function(algo_id, task_id) {
  runs = get_runs_local(algo_id, task_id)
  runtime = runs$runtime
  scimark = runs$scimark
  norm.rt = log(runtime + 1) / scimark
  mad(norm.rt)
})
var.norm.runtime = my_apply(runs, function(algo_id, task_id) {
  runs = get_runs_local(algo_id, task_id)
  runtime = runs$runtime
  scimark = runs$scimark
  norm.rt = log(runtime + 1) / scimark
  var(norm.rt)
})
online = my_apply(runs, function(algo_id, task_id) {
  of = make_omlbenchfunction(algo_id, task_id, include.extras = TRUE)
  par.set = getParamSet(of)
  x = sampleValue(par.set)
  tryCatch({ of(x); TRUE}, error = function(e) FALSE)
})
density = my_apply(runs, function(algo_id, task_id) {
  of = make_omlbenchfunction(algo_id, task_id, include.extras = TRUE)
  par.set = getParamSet(of)
  xs = rbindlist(sampleValues(par.set, 10))
  v = tryCatch(of(xs), error = function(e) NULL)
  print(paste0(algo_id, "-", task_id))
  if (is.null(v)) {
    NA
  } else {
    dists = lapply(attr(v, "extras"), function(y) {
      y$.lookup.distance
    })
    mean(simplify2array(dists))
  }
})

accuracy.hists = paste0("<a href='hist_acc/plots-'", seq_along(runs[,1]),".png' target='_blank'><img src='hist_acc/plots-", seq_along(runs[,1]),".png' /></a>")
runtime.hists = paste0("<a href='rt/plots2-'", seq_along(runs[,1]),".png' target='_blank'><img src='hist_rt/plots2-", seq_along(runs[,1]),".png' /></a>")
```
```{r table, echo = FALSE}
t = data.frame(runs, n.runs, sprintf("%.2f", maxq), sprintf("%.4f", mad.runtime), sprintf("%e", mad.norm.runtime), sprintf("%e", density), accuracy.hists, runtime.hists)
datatable(t, colnames = c("Learner", "Task ID", "# Runs", "max - 0.95q", "log. Runtime (MAD)", "log. Runtime / Scimark (MAD)", "Density", "Accuracy", "Runtime / Scimark"), escape = FALSE, filter = "top")
```
